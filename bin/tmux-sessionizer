#!/usr/bin/env bash

fzf="fzf -i --no-unicode --prompt=: --info=inline --header-first --header tmux-sessionizer --height 50% --reverse"

directory=$({ \
	find ~/work ~/personal/ ~/w ~/vm \
		-maxdepth 1 \
		-mindepth 1 \
		-type d; \
	} | grep -v '\.git\/' | ${fzf})

if [ -z "${directory}" ]; then
	exit $LINENO
else
	session_name="$(basename $(dirname ${directory}))/$(basename ${directory} | tr . _)"
fi


if [ -n "${directory}" ]; then
	exists=$(tmux list-sessions 2>/dev/null | awk -F ':' '{print $1;}' | grep -c "\\b${session_name}\\b")

	# printf '[%s]\n' ${exists} ${directory} ${session_name} ${TMUX}
	# exit $LINENO

	if [ "${exists}" == '0' ]; then
		tmux new-session -s "${session_name}" -c "${directory}" -d
	fi

	if [ "${TMUX}" != '' ]; then
		tmux switch-client -t ${session_name}
	else
		tmux attach-session -t ${session_name}
	fi
else
	exit $LINENO
fi
